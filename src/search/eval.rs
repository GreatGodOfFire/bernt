use crate::{
    bitloop,
    position::{PieceColor, PieceType, Position},
};

pub fn eval(pos: &Position) -> (i32, i32, i32, i32) {
    let mut mg = 0;
    let mut eg = 0;
    let mut phase = 0;

    bitloop!(pos.colors[0] | pos.colors[1] => sq, {
        let piece = pos.piece_at(sq);

        if piece.ty != PieceType::None {
            let sign = if piece.color == pos.side { 1 } else { -1 };
            mg += MG_PSTS[piece.ty][flip(sq, piece.color) as usize] * sign;
            eg += EG_PSTS[piece.ty][flip(sq, piece.color) as usize] * sign;
            phase += PHASE[piece.ty];
        }
    });
    phase = phase.min(24);

    ((mg * phase + eg * (24 - phase)) / 24, mg, eg, phase)
}

#[inline]
pub(super) fn flip(sq: u8, side: PieceColor) -> u8 {
    if side == PieceColor::White {
        sq
    } else {
        sq ^ 56
    }
}

pub(super) const PHASE: [i32; 6] = [0, 1, 1, 2, 4, 0];

pub(super) const MG_PSTS: [[i32; 64]; 6] =
    [MG_PAWN, MG_KNIGHT, MG_BISHOP, MG_ROOK, MG_QUEEN, MG_KING];
pub(super) const EG_PSTS: [[i32; 64]; 6] =
    [EG_PAWN, EG_KNIGHT, EG_BISHOP, EG_ROOK, EG_QUEEN, EG_KING];

#[rustfmt::skip]
const MG_PAWN: [i32; 64] = [
       0,    0,    0,    0,    0,    0,    0,    0,
      37,   75,   57,   60,   73,   99,  134,   65,
      51,   88,   69,   78,   85,   74,  129,   73,
      48,   78,   76,   96,   98,   86,   96,   50,
      54,   97,   98,  114,  121,   97,   99,   47,
      93,  141,  134,  152,  144,  142,  112,   91,
     184,  193,  203,  195,  170,  132,  126,  125,
       0,    0,    0,    0,    0,    0,    0,    0,
];
#[rustfmt::skip]
const MG_KNIGHT: [i32; 64] = [
     296,  283,  261,  293,  286,  291,  299,  275,
     257,  280,  294,  306,  310,  329,  312,  296,
     280,  309,  313,  332,  342,  328,  341,  306,
     306,  311,  331,  334,  355,  354,  356,  333,
     307,  319,  364,  399,  365,  408,  346,  358,
     296,  333,  373,  395,  386,  415,  365,  332,
     292,  288,  353,  346,  341,  352,  317,  315,
     278,  310,  307,  306,  315,  312,  316,  307,
];
#[rustfmt::skip]
const MG_BISHOP: [i32; 64] = [
     281,  317,  322,  310,  320,  325,  321,  310,
     324,  335,  331,  331,  354,  326,  367,  306,
     334,  367,  349,  351,  337,  362,  358,  339,
     340,  362,  372,  371,  372,  358,  352,  334,
     363,  353,  369,  416,  384,  375,  360,  369,
     317,  341,  367,  370,  371,  378,  369,  377,
     321,  349,  346,  343,  336,  351,  333,  331,
     303,  327,  331,  329,  327,  323,  327,  318,
];
#[rustfmt::skip]
const MG_ROOK: [i32; 64] = [
     460,  459,  475,  480,  483,  475,  405,  448,
     443,  501,  463,  440,  462,  478,  474,  381,
     441,  457,  469,  463,  471,  466,  481,  427,
     448,  461,  468,  471,  483,  488,  496,  462,
     467,  470,  486,  498,  537,  522,  510,  477,
     476,  510,  499,  528,  537,  544,  512,  508,
     498,  517,  561,  546,  553,  536,  521,  515,
     522,  549,  526,  532,  543,  516,  514,  522,
];
#[rustfmt::skip]
const MG_QUEEN: [i32; 64] = [
     877,  848,  863,  891,  855,  846,  884,  863,
     879,  876,  900,  893,  898,  889,  883,  872,
     895,  892,  893,  892,  881,  900,  893,  883,
     882,  885,  887,  896,  908,  898,  899,  884,
     884,  894,  912,  931,  943,  952,  908,  927,
     876,  917,  921,  949,  960,  995,  965,  941,
     887,  901,  925,  929,  934,  951,  943,  954,
     892,  905,  923,  926,  932,  930,  927,  927,
];
#[rustfmt::skip]
const MG_KING: [i32; 64] = [
     -15,   -4,   29,  -44,   34,  -26,   63,   67,
       2,   -3,   24,  -25,  -64,   -5,   26,   42,
      -5,   -6,  -20,  -37,  -47,  -23,    1,   -2,
      -1,   -8,   -5,   -3,  -10,   -7,   -1,  -16,
      -0,   10,    0,   -5,    6,    1,    4,   -4,
       2,    5,    5,    3,    6,    3,  -10,   -2,
       6,    7,    3,    1,   36,  -12,   -2,   -4,
       3,   11,    6,    5,    3,   -2,    1,    2,
];
#[rustfmt::skip]
const EG_PAWN: [i32; 64] = [
       0,    0,    0,    0,    0,    0,    0,    0,
     153,  149,  141,  121,  145,  138,  131,  122,
     153,  137,  117,  124,  120,  124,  118,  132,
     165,  137,  125,  124,  102,  105,  136,  131,
     172,  170,  139,  125,  120,  132,  146,  160,
     222,  239,  217,  202,  177,  185,  209,  203,
     270,  281,  279,  231,  203,  231,  261,  251,
       0,    0,    0,    0,    0,    0,    0,    0,
];
#[rustfmt::skip]
const EG_KNIGHT: [i32; 64] = [
     275,  237,  273,  283,  270,  271,  236,  268,
     274,  290,  257,  280,  261,  245,  285,  300,
     259,  282,  263,  285,  277,  272,  262,  255,
     276,  251,  297,  291,  294,  276,  285,  245,
     287,  279,  295,  169,  299,  287,  318,  286,
     263,  268,  300,  298,  313,  292,  298,  298,
     282,  294,  244,  291,  287,  296,  304,  301,
     291,  277,  296,  294,  293,  302,  297,  292,
];
#[rustfmt::skip]
const EG_BISHOP: [i32; 64] = [
     267,  313,  259,  296,  278,  287,  302,  302,
     258,  275,  308,  298,  285,  299,  284,  295,
     300,  292,  306,  315,  311,  302,  306,  315,
     312,  291,  290,  302,  322,  312,  305,  312,
     248,  316,  315,  300,  322,  335,  325,  298,
     318,  287,  302,  325,  302,  330,  336,  317,
     310,  300,  297,  314,  333,  265,  304,  308,
     316,  323,  325,  310,  313,  316,  279,  315,
];
#[rustfmt::skip]
const EG_ROOK: [i32; 64] = [
     459,  468,  468,  476,  468,  456,  520,  437,
     410,  353,  445,  464,  458,  428,  443,  444,
     469,  453,  473,  469,  467,  481,  475,  470,
     484,  479,  504,  489,  490,  468,  481,  493,
     490,  503,  507,  492,  484,  493,  497,  480,
     509,  498,  509,  501,  514,  519,  506,  502,
     515,  496,  497,  500,  516,  510,  510,  504,
     486,  459,  485,  472,  484,  497,  503,  498,
];
#[rustfmt::skip]
const EG_QUEEN: [i32; 64] = [
     877,  881,  866,  836,  871,  864,  884,  881,
     879,  894,  831,  862,  851,  882,  872,  876,
     890,  879,  895,  884,  900,  898,  894,  880,
     884,  904,  918,  933,  907,  920,  929,  932,
     894,  898,  915,  923,  944,  923,  941,  928,
     895,  911,  920,  925,  940,  951,  937,  925,
     897,  917,  936,  937,  945,  934,  919,  921,
     892,  905,  914,  924,  930,  927,  918,  916,
];
#[rustfmt::skip]
const EG_KING: [i32; 64] = [
      -7,  -21,  -31,  -25,  -63,  -17,  -32,  -51,
     -13,  -15,   -5,   -4,   13,    3,  -11,  -26,
     -26,   -2,   -7,    9,   19,   22,   -8,  -20,
       4,  -14,    1,   21,   20,   11,    5,    3,
     -30,  -91,   16,   44,   39,   28,   23,   11,
     -52,   19,   -2,    6,   19,   31,   10,  -64,
       7,   21,   40,   22, -191,   14,  -27,   -3,
      19,   85,  100,   45,   45,   56,   31,   -1,
];
