use crate::{
    bitloop,
    position::{PieceColor, PieceType, Position},
};

pub fn eval(pos: &Position) -> (i32, i32, i32, i32) {
    let mut mg = 0;
    let mut eg = 0;
    let mut phase = 0;

    bitloop!(pos.colors[0] | pos.colors[1] => sq, {
        let piece = pos.piece_at(sq);

        if piece.ty != PieceType::None {
            let sign = if piece.color == pos.side { 1 } else { -1 };
            mg += MG_PSTS[piece.ty][flip(sq, piece.color) as usize] * sign;
            eg += EG_PSTS[piece.ty][flip(sq, piece.color) as usize] * sign;
            phase += PHASE[piece.ty];
        }
    });
    phase = phase.min(24);

    ((mg * phase + eg * (24 - phase)) / 24, mg, eg, phase)
}

#[inline]
pub(super) fn flip(sq: u8, side: PieceColor) -> u8 {
    if side == PieceColor::White {
        sq
    } else {
        sq ^ 56
    }
}

pub(super) const PHASE: [i32; 6] = [0, 1, 1, 2, 4, 0];

pub(super) const MG_PSTS: [[i32; 64]; 6] =
    [MG_PAWN, MG_KNIGHT, MG_BISHOP, MG_ROOK, MG_QUEEN, MG_KING];
pub(super) const EG_PSTS: [[i32; 64]; 6] =
    [EG_PAWN, EG_KNIGHT, EG_BISHOP, EG_ROOK, EG_QUEEN, EG_KING];

#[rustfmt::skip]
const MG_PAWN: [i32; 64] = [
       0,    0,    0,    0,    0,    0,    0,    0,
      23,   57,   45,   28,   33,   75,   83,   15,
      38,   63,   60,   43,   73,   61,  103,   22,
      27,   72,   78,   87,   85,   71,   45,   17,
      33,   86,   77,  104,   85,   63,   74,    3,
      69,  115,  135,  131,  111,  117,  104,   79,
     188,  146,  156,  160,  118,  157,   83,  153,
       0,    0,    0,    0,    0,    0,    0,    0,
];
#[rustfmt::skip]
const MG_KNIGHT: [i32; 64] = [
     219,  264,  294,  302,  298,  289,  280,  268,
     276,  286,  334,  292,  303,  305,  283,  268,
     281,  254,  314,  325,  402,  325,  330,  295,
     305,  274,  307,  305,  342,  332,  309,  314,
     310,  311,  366,  352,  335,  389,  330,  353,
     290,  331,  338,  380,  355,  367,  343,  321,
     279,  284,  339,  316,  312,  333,  283,  293,
     197,  298,  276,  304,  287,  279,  298,  278,
];
#[rustfmt::skip]
const MG_BISHOP: [i32; 64] = [
     263,  306,  319,  294,  271,  313,  293,  270,
     313,  356,  314,  337,  352,  328,  368,  321,
     351,  361,  378,  345,  318,  338,  327,  314,
     302,  354,  345,  328,  374,  348,  321,  317,
     341,  349,  378,  369,  372,  341,  357,  312,
     325,  311,  352,  379,  334,  355,  353,  395,
     275,  332,  336,  307,  311,  307,  324,  315,
     261,  308,  301,  302,  295,  300,  304,  300,
];
#[rustfmt::skip]
const MG_ROOK: [i32; 64] = [
     449,  454,  460,  475,  494,  480,  452,  460,
     419,  452,  456,  440,  474,  466,  458,  421,
     473,  489,  426,  448,  485,  442,  493,  464,
     444,  455,  461,  451,  473,  503,  502,  474,
     477,  477,  500,  466,  522,  499,  522,  505,
     516,  522,  494,  520,  553,  508,  503,  517,
     524,  530,  503,  525,  547,  507,  517,  532,
     491,  528,  491,  502,  503,  505,  486,  480,
];
#[rustfmt::skip]
const MG_QUEEN: [i32; 64] = [
     889,  855,  868,  916,  892,  861,  850,  905,
     908,  902,  918,  912,  896,  884,  888,  888,
     848,  894,  898,  898,  882,  915,  897,  894,
     882,  877,  880,  885,  926,  893,  911,  928,
     871,  892,  908,  892,  927,  948,  913,  924,
     888,  901,  921,  949,  947,  942,  965,  935,
     890,  878,  902,  913,  933,  962,  924,  950,
     859,  902,  925,  922,  920,  905,  934,  943,
];
#[rustfmt::skip]
const MG_KING: [i32; 64] = [
      15,  -28,   14,    1,   36,  -31,   85,   82,
      22,  -30,  -11,  -34,  -46,   -2,   -1,   -9,
     -14,  -12,  -28,  -53,  -49,  -44,  -34,  -34,
      -5,   -6,    8,   -4,   10,   -1,   -9,   -0,
      11,   10,   -3,    2,   15,   38,   10,   11,
       7,    3,    1,    5,   16,   12,   10,   10,
      -1,    2,    2,    9,   11,    5,   11,   -0,
       1,   -2,    3,    2,    5,    1,    6,    1,
];
#[rustfmt::skip]
const EG_PAWN: [i32; 64] = [
       0,    0,    0,    0,    0,    0,    0,    0,
     159,  127,  140,  164,  150,  141,  167,  158,
     158,  123,  110,  145,  110,  132,  147,  175,
     159,  128,  121,  128,  119,  138,  171,  192,
     178,  161,  168,  123,  152,  175,  165,  210,
     222,  155,  164,  166,  195,  261,  216,  218,
     212,  269,  246,  211,  214,  295,  253,  202,
       0,    0,    0,    0,    0,    0,    0,    0,
];
#[rustfmt::skip]
const EG_KNIGHT: [i32; 64] = [
     245,  193,  271,  201,  232,  238,  229,  281,
     297,  244,  257,  262,  269,  238,  243,  261,
     271,  285,  268,  287,  186,  267,  298,  253,
     234,  317,  270,  297,  271,  288,  268,  293,
     308,  318,  260,  321,  320,  272,  283,  282,
     311,  296,  308,  302,  255,  285,  280,  283,
     289,  283,  276,  262,  292,  293,  277,  252,
     252,  307,  271,  297,  274,  255,  296,  259,
];
#[rustfmt::skip]
const EG_BISHOP: [i32; 64] = [
     303,  296,  243,  287,  318,  234,  282,  289,
     341,  308,  302,  285,  284,  265,  268,  291,
     290,  336,  317,  300,  316,  290,  288,  282,
     282,  311,  324,  312,  287,  294,  320,  273,
     321,  320,  265,  307,  304,  294,  306,  309,
     315,  301,  334,  300,  298,  294,  321,  283,
     281,  312,  293,  311,  247,  338,  290,  306,
     323,  287,  299,  262,  294,  253,  312,  296,
];
#[rustfmt::skip]
const EG_ROOK: [i32; 64] = [
     426,  458,  471,  455,  455,  451,  445,  399,
     426,  440,  465,  461,  465,  446,  449,  467,
     433,  465,  495,  470,  443,  466,  415,  434,
     459,  459,  474,  495,  475,  467,  450,  446,
     469,  478,  484,  483,  476,  487,  463,  459,
     448,  471,  470,  480,  447,  470,  479,  446,
     487,  490,  500,  495,  472,  471,  480,  476,
     484,  506,  487,  496,  480,  487,  466,  487,
];
#[rustfmt::skip]
const EG_QUEEN: [i32; 64] = [
     865,  890,  881,  819,  868,  875,  867,  905,
     898,  903,  863,  866,  876,  882,  882,  892,
     880,  895,  894,  877,  896,  913,  887,  890,
     887,  893,  910,  899,  869,  898,  880,  913,
     876,  883,  916,  889,  944,  916,  932,  905,
     907,  890,  915,  909,  911,  902,  908,  904,
     909,  881,  930,  896,  916,  900,  907,  903,
     892,  895,  922,  919,  918,  899,  902,  892,
];
#[rustfmt::skip]
const EG_KING: [i32; 64] = [
    -131,  -58,  -57,  -71,  -73,  -15,  -58,  -52,
     -78,  -25,  -28,   -7,    3,   -6,   -3,  -29,
      -4,   -5,    1,   14,   31,   35,   15,  -23,
       5,   16,   15,   21,    8,    3,    6,    1,
      30,   43,   13,   11,    7,  -79,   14,    3,
      38,   19,   35,   16,  -18,   -1,   37,   42,
      15,   25,   24,   29,   44,   32,   39,   14,
      11,    6,   12,   22,   28,   11,   30,    2,
];
