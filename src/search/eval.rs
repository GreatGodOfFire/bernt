use crate::{
    bitloop,
    position::{PieceColor, PieceType, Position},
};

pub fn eval(pos: &Position) -> (i32, i32, i32, i32) {
    let mut mg = 0;
    let mut eg = 0;
    let mut phase = 0;

    bitloop!(pos.colors[0] | pos.colors[1] => sq, {
        let piece = pos.piece_at(sq);

        if piece.ty != PieceType::None {
            let sign = if piece.color == pos.side { 1 } else { -1 };
            mg += MG_PSTS[piece.ty][flip(sq, piece.color) as usize] * sign;
            eg += EG_PSTS[piece.ty][flip(sq, piece.color) as usize] * sign;
            phase += PHASE[piece.ty];
        }
    });
    phase = phase.min(24);

    ((mg * phase + eg * (24 - phase)) / 24, mg, eg, phase)
}

#[inline]
pub(super) fn flip(sq: u8, side: PieceColor) -> u8 {
    if side == PieceColor::White {
        sq
    } else {
        sq ^ 56
    }
}

pub(super) const PHASE: [i32; 6] = [0, 1, 1, 2, 4, 0];

pub(super) const MG_PSTS: [[i32; 64]; 6] =
    [MG_PAWN, MG_KNIGHT, MG_BISHOP, MG_ROOK, MG_QUEEN, MG_KING];
pub(super) const EG_PSTS: [[i32; 64]; 6] =
    [EG_PAWN, EG_KNIGHT, EG_BISHOP, EG_ROOK, EG_QUEEN, EG_KING];

#[rustfmt::skip]
const MG_PAWN: [i32; 64] = [
       0,    0,    0,    0,    0,    0,    0,    0,
      15,   73,   59,   47,   46,  108,  138,   48,
      23,   75,   77,   72,   77,   81,  137,   50,
      25,   70,   80,  100,  104,   92,  108,   43,
      34,   94,   89,  116,  121,  117,  112,   61,
      58,  108,  108,  162,  157,  167,  118,  111,
     177,  182,  168,  183,  169,  148,  115,  125,
       0,    0,    0,    0,    0,    0,    0,    0,
];
#[rustfmt::skip]
const MG_KNIGHT: [i32; 64] = [
     289,  292,  292,  263,  310,  290,  293,  305,
     292,  296,  304,  320,  311,  327,  298,  303,
     296,  334,  330,  346,  341,  340,  343,  301,
     306,  322,  351,  354,  357,  361,  338,  316,
     326,  346,  382,  377,  373,  386,  381,  361,
     312,  363,  351,  408,  474,  390,  394,  314,
     305,  313,  359,  335,  340,  364,  300,  317,
     244,  310,  313,  320,  326,  299,  315,  276,
];
#[rustfmt::skip]
const MG_BISHOP: [i32; 64] = [
     321,  329,  351,  323,  323,  325,  325,  323,
     333,  388,  355,  358,  370,  363,  384,  323,
     365,  378,  379,  374,  361,  381,  377,  355,
     347,  372,  374,  394,  391,  372,  355,  354,
     357,  376,  398,  393,  400,  410,  386,  371,
     340,  373,  387,  422,  391,  405,  401,  409,
     327,  343,  368,  344,  375,  354,  363,  319,
     317,  326,  330,  325,  342,  322,  320,  355,
];
#[rustfmt::skip]
const MG_ROOK: [i32; 64] = [
     467,  474,  477,  488,  498,  480,  452,  454,
     435,  489,  474,  469,  470,  474,  483,  402,
     442,  450,  466,  463,  463,  454,  487,  443,
     460,  474,  479,  491,  492,  495,  489,  470,
     503,  481,  498,  513,  524,  516,  502,  481,
     497,  536,  535,  538,  542,  521,  526,  508,
     533,  534,  548,  544,  550,  542,  527,  530,
     519,  506,  504,  523,  506,  509,  524,  522,
];
#[rustfmt::skip]
const MG_QUEEN: [i32; 64] = [
     879,  876,  890,  907,  883,  827,  879,  890,
     849,  888,  912,  902,  907,  903,  877,  883,
     887,  903,  903,  893,  888,  913,  910,  888,
     914,  880,  892,  902,  905,  913,  920,  898,
     898,  912,  917,  919,  938,  926,  922,  920,
     909,  907,  928,  944,  951,  968,  953,  948,
     909,  908,  921,  923,  926,  957,  926,  949,
     903,  917,  926,  929,  940,  930,  912,  907,
];
#[rustfmt::skip]
const MG_KING: [i32; 64] = [
     -10,   20,   36,  -23,   50,  -11,  104,   96,
       5,    5,    1,  -37,  -46,   11,   29,   64,
     -25,  -13,  -23,  -51,  -42,  -31,  -18,  -21,
      -2,   -1,   -6,   -3,   -4,   -5,   -8,  -13,
      -7,   -1,   -2,   -7,    1,   11,   -2,    5,
       1,   -0,   -2,    1,    7,    6,    7,    9,
       1,    3,   12,  -13,    4,    7,   16,   37,
      -7, -114,  -64,   -9,   -1,   -0,   28,   45,
];
#[rustfmt::skip]
const EG_PAWN: [i32; 64] = [
       0,    0,    0,    0,    0,    0,    0,    0,
     191,  175,  169,  147,  156,  151,  147,  157,
     171,  161,  144,  131,  133,  130,  125,  137,
     175,  166,  141,  123,  109,  128,  138,  134,
     200,  194,  156,  133,  133,  135,  145,  158,
     263,  260,  229,  195,  182,  176,  189,  200,
     320,  320,  289,  251,  249,  220,  255,  227,
       0,    0,    0,    0,    0,    0,    0,    0,
];
#[rustfmt::skip]
const EG_KNIGHT: [i32; 64] = [
     278,  194,  271,  270,  274,  259,  220,  303,
     291,  278,  284,  281,  275,  246,  288,  266,
     240,  268,  286,  292,  292,  262,  263,  242,
     286,  292,  313,  288,  284,  283,  285,  283,
     308,  297,  295,  333,  323,  319,  153,  282,
     305,  326,  325,  311,  181,  327,  304,  311,
     284,  312,  283,  312,  326,  249,  280,  256,
     288,  299,  311,  294,  311,  287,  303,  269,
];
#[rustfmt::skip]
const EG_BISHOP: [i32; 64] = [
     313,  347,  242,  302,  298,  273,  327,  311,
     323,  300,  307,  327,  321,  315,  297,  315,
     299,  326,  342,  335,  356,  332,  317,  315,
     333,  329,  362,  351,  325,  332,  333,  309,
     340,  354,  334,  357,  342,  313,  319,  314,
     345,  357,  345,  318,  349,  310,  253,  302,
     320,  350,  344,  343,  249,  339,  348,  323,
     339,  327,  338,  308,  342,  317,  321,  335,
];
#[rustfmt::skip]
const EG_ROOK: [i32; 64] = [
     446,  444,  470,  460,  430,  432,  411,  391,
     424,  434,  449,  432,  409,  414,  376,  424,
     470,  470,  466,  460,  462,  463,  434,  445,
     490,  479,  493,  477,  462,  463,  460,  468,
     491,  491,  495,  485,  467,  474,  468,  476,
     502,  495,  487,  495,  479,  465,  480,  499,
     493,  489,  502,  508,  482,  478,  476,  495,
     486,  493,  507,  504,  494,  497,  467,  508,
];
#[rustfmt::skip]
const EG_QUEEN: [i32; 64] = [
     882,  875,  870,  838,  871,  828,  867,  890,
     887,  877,  845,  860,  784,  866,  869,  885,
     883,  878,  890,  886,  874,  805,  898,  881,
     881,  892,  910,  918,  895,  882,  828,  915,
     900,  918,  909,  935,  935,  935,  899,  912,
     893,  903,  913,  939,  932,  935,  925,  915,
     898,  932,  949,  936,  939,  927,  889,  918,
     902,  908,  914,  927,  941,  921,  898,  893,
];
#[rustfmt::skip]
const EG_KING: [i32; 64] = [
     -11,  -30,  -43,  -28,  -67,  -21,  -37,  -56,
     -20,  -19,  -13,   -8,   10,   -1,  -14,  -33,
     -35,   -3,   -6,   11,   21,   22,  -10,  -24,
       4,  -16,   -1,   20,   20,   10,    3,    4,
     -35,  -92,   12,   41,   35,   25,   20,    8,
     -55,   15,   -3,    3,   16,   24,    7,  -71,
       8,   22,   42,   19, -179,   11,  -33,  -10,
      37,  170,  155,   44,   41,   59,   36,   -6,
];
